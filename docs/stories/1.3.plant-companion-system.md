# Story 1.3: Plant Companion System

## Story Overview

**Story ID**: 1.3
**Epic**: Foundation & Plant Companion Core
**Estimated Effort**: 2 hours
**Priority**: Critical (Core emotional value)

## User Story

As a **user**,
I want **to have a virtual plant that grows through 5 distinct stages when I complete TODOs**,
So that **I feel emotional reward and companionship from my daily achievements**.

## Acceptance Criteria

### Plant Growth Logic (Backend)
1. ✅ PlantService with growth calculation algorithms
2. ✅ Plant growth points increase by 10 per completed TODO
3. ✅ Plant evolves through 5 stages: Seed(1) → Sprout(2) → Young(3) → Mature(4) → Blooming(5)
4. ✅ Growth stage calculation: `stage = min(5, floor(growthPoints / 20) + 1)`
5. ✅ `lastInteractionAt` timestamp updated on each growth

### Plant State Management
6. ✅ Plant API endpoints for retrieving plant status
7. ✅ Growth progression calculation (points to next stage)
8. ✅ Plant repository with growth tracking queries
9. ✅ Transaction safety for TODO completion + plant growth
10. ✅ Default plant automatically created with initial user

### Visual Plant Representation
11. ✅ 5 distinct plant images/SVGs for each growth stage
12. ✅ Plant component displays current stage visually
13. ✅ Stage progression indicator (progress bar or level display)
14. ✅ Plant state updates immediately after TODO completion
15. ✅ Responsive plant display for mobile and desktop

### Growth Integration with TODOs
16. ✅ TODO completion triggers plant growth automatically
17. ✅ PlantService.growPlant() called from TodoService.completeTodo()
18. ✅ Atomic transaction ensures data consistency
19. ✅ Growth response includes both TODO and plant data
20. ✅ Frontend receives updated plant state in completion response

## Technical Implementation Details

### Implementation Sequence (Critical Order)
1. **PlantService Growth Logic** → Core algorithms first
2. **Plant API Endpoints** → Backend services
3. **Transaction Integration** → Connect with TODO completion
4. **Plant Images/SVGs** → Visual assets preparation
5. **Frontend Plant Component** → UI implementation
6. **Integration Testing** → End-to-end growth verification

### Growth Calculation Algorithm

**Stage Progression Logic**:
```java
public class PlantGrowthService {
    private static final int POINTS_PER_STAGE = 20;
    private static final int POINTS_PER_TODO = 10;
    private static final int MAX_STAGE = 5;

    public PlantStage calculateStage(int growthPoints) {
        int stage = Math.min(MAX_STAGE, (growthPoints / POINTS_PER_STAGE) + 1);
        return PlantStage.fromLevel(stage);
    }

    public int getProgressToNextStage(int growthPoints, int currentStage) {
        if (currentStage >= MAX_STAGE) return 100; // Fully grown
        int pointsForCurrentStage = (currentStage - 1) * POINTS_PER_STAGE;
        int progressInStage = growthPoints - pointsForCurrentStage;
        return (progressInStage * 100) / POINTS_PER_STAGE;
    }
}
```

### Plant Entity Enhancements

**Additional Plant.java fields**:
```java
@Entity
@Table(name = "plants")
public class Plant extends BaseEntity {
    // ... existing fields ...

    @Column(name = "growth_points", nullable = false)
    private Integer growthPoints = 0;

    @Enumerated(EnumType.STRING)
    @Column(name = "current_stage", nullable = false)
    private PlantStage currentStage = PlantStage.SEED;

    @Column(name = "total_todos_completed")
    private Integer totalTodosCompleted = 0;

    @Column(name = "last_interaction_at")
    private LocalDateTime lastInteractionAt;
}

public enum PlantStage {
    SEED(1, "씨앗", "plant-seed.svg"),
    SPROUT(2, "새싹", "plant-sprout.svg"),
    YOUNG(3, "어린 식물", "plant-young.svg"),
    MATURE(4, "성장한 식물", "plant-mature.svg"),
    BLOOMING(5, "꽃피는 식물", "plant-blooming.svg");

    private final int level;
    private final String displayName;
    private final String imageFile;
}
```

### Required API Endpoints

**PlantController.java**:
```java
@RestController
@RequestMapping("/api/plants")
public class PlantController {
    @GetMapping("/{id}")
    public PlantResponse getPlant(@PathVariable Long id);

    @GetMapping("/{id}/growth-status")
    public PlantGrowthStatusResponse getGrowthStatus(@PathVariable Long id);

    @PostMapping("/{id}/grow")
    public PlantResponse growPlant(@PathVariable Long id, @RequestBody GrowthRequest request);
}
```

### Plant Response DTOs

**PlantResponse.java**:
```java
public class PlantResponse {
    private Long id;
    private String name;
    private String species;
    private Integer growthPoints;
    private PlantStage currentStage;
    private Integer totalTodosCompleted;
    private Integer progressToNextStage; // 0-100 percentage
    private String stageImageUrl;
    private LocalDateTime lastInteractionAt;
}
```

### Frontend Plant Component

**PlantView.tsx**:
```typescript
interface PlantViewProps {
    plant: Plant;
    onGrowthComplete?: (newStage: PlantStage) => void;
}

export const PlantView: React.FC<PlantViewProps> = ({ plant, onGrowthComplete }) => {
    return (
        <div className="plant-container">
            <div className="plant-image">
                <img
                    src={`/images/plants/${plant.currentStage.toLowerCase()}.svg`}
                    alt={`${plant.name} - ${plant.currentStage} 단계`}
                    aria-label={`${plant.name}, ${plant.currentStage} 단계, 레벨 ${plant.level}`}
                />
            </div>

            <div className="plant-info">
                <h3>{plant.name}</h3>
                <div className="stage-info">
                    <span>단계: {plant.currentStage}</span>
                    <span>성장 포인트: {plant.growthPoints}</span>
                </div>

                {plant.currentStage < 5 && (
                    <div className="progress-bar">
                        <div
                            className="progress-fill"
                            style={{ width: `${plant.progressToNextStage}%` }}
                        />
                        <span>다음 단계까지 {100 - plant.progressToNextStage}%</span>
                    </div>
                )}
            </div>
        </div>
    );
};
```

### Transaction Integration

**Enhanced TodoService.completeTodo()**:
```java
@Transactional
public TodoCompletionResponse completeTodo(Long todoId) {
    Todo todo = todoRepository.findById(todoId)
        .orElseThrow(() -> new TodoNotFoundException(todoId));

    if (todo.getCompleted()) {
        throw new TodoAlreadyCompletedException(todoId);
    }

    // Mark TODO as complete
    todo.setCompleted(true);
    todo.setCompletedAt(LocalDateTime.now());
    Todo savedTodo = todoRepository.save(todo);

    // Grow the plant
    Plant updatedPlant = plantService.growPlant(todo.getPlantId());

    return TodoCompletionResponse.builder()
        .todo(TodoResponse.fromEntity(savedTodo))
        .plant(PlantResponse.fromEntity(updatedPlant))
        .growthMessage(generateGrowthMessage(updatedPlant))
        .stageChanged(plantService.didStageChange(updatedPlant))
        .build();
}
```

## Definition of Done Checklist

### Backend Growth Logic Verification
- [ ] Plant growth points increase correctly (+10 per TODO)
- [ ] Stage calculation algorithm works for all scenarios (0-100+ points)
- [ ] Stage transitions occur at correct point thresholds (20, 40, 60, 80)
- [ ] Progress calculation returns accurate percentages
- [ ] Maximum stage (5) handling prevents overflow

### Database Integration Verification
- [ ] Plant updates occur atomically with TODO completion
- [ ] Transaction rollback works if either operation fails
- [ ] lastInteractionAt timestamp updates on growth
- [ ] totalTodosCompleted counter increments correctly
- [ ] Plant state persists across application restarts

### API Endpoints Verification
- [ ] GET /api/plants/{id} returns complete plant data
- [ ] GET /api/plants/{id}/growth-status returns progression info
- [ ] Plant responses include all calculated fields
- [ ] Error handling for non-existent plants (404)
- [ ] Proper JSON serialization of enum values

### Frontend Plant Display Verification
- [ ] Plant images display correctly for each stage
- [ ] Stage progression indicator shows accurate progress
- [ ] Plant component updates immediately after TODO completion
- [ ] Responsive design works on mobile and desktop
- [ ] Accessibility attributes properly set for screen readers

### Growth Integration Verification
- [ ] TODO completion triggers plant growth automatically
- [ ] Frontend receives updated plant data in completion response
- [ ] Stage transitions show visual change immediately
- [ ] Progress bar updates reflect new growth points
- [ ] Multiple TODO completions accumulate growth correctly

## Success Criteria

Story is complete when:
1. **Emotional reward system functional** - Plant visibly grows from TODO completion
2. **5-stage progression working** - Clear visual distinction between all stages
3. **Growth algorithm accurate** - Points and stage calculations mathematically correct
4. **Transaction integrity maintained** - TODO and plant data always consistent
5. **User experience smooth** - No delays or glitches in growth feedback
6. **Ready for animation** - Plant state changes available for Story 1.4

## Blocking Dependencies

**Blocked By**:
- Story 1.1 (Foundation & Database Setup)
- Story 1.2 (Basic TODO Management)

**Blocks**: Story 1.4 (Growth Animation & Feedback)

## Critical Notes for Implementer

- **Growth Algorithm**: Use exact formula - stage = min(5, floor(points/20) + 1)
- **Transaction Safety**: TODO completion and plant growth must be atomic
- **Visual Assets**: Prepare 5 distinct, recognizable plant stage images
- **Performance**: Growth calculations should complete within 100ms
- **Data Integrity**: Validate growth points never decrease unexpectedly
- **Error Recovery**: Handle edge cases like invalid plant IDs gracefully
- **Accessibility**: Ensure plant state is communicated to screen readers

## Test Scenarios

1. **Growth Progression**: Complete 1, 2, 5, 10, 15 TODOs and verify stage transitions
2. **Progress Calculation**: Verify progress percentage at various point levels
3. **Transaction Rollback**: Simulate database error during growth, verify TODO rollback
4. **Stage Boundaries**: Test growth at exact stage transition points (19, 20, 21 points)
5. **Maximum Stage**: Complete 50+ TODOs, verify plant stays at stage 5
6. **Visual Updates**: Complete TODO and verify plant component reflects new state immediately